{% extends "base.html" %}

{% block title %}Analys Vecka {{ coupon.week_number }} - Stryktips Bot{% endblock %}

{% block content %}
<div class="analysis-header">
    <h2>Detaljerad Analys - Vecka {{ coupon.week_number }}, {{ coupon.year }}</h2>
    <a href="/coupon/{{ coupon.id }}" class="btn btn-secondary">Visa kupong</a>
</div>

<section class="matches-analysis">
    {% for match in coupon.matches %}
        <div class="match-analysis-card">
            <div class="match-header">
                <span class="match-number">{{ match.match_number }}</span>
                <h3>{{ match.home_team }} - {{ match.away_team }}</h3>
                <span class="kickoff">{{ match.kickoff_time.strftime('%d/%m %H:%M') }}</span>
            </div>

            {% if match.analysis %}
            <div class="analysis-details">
                <div class="value-section">
                    <h4>V√§rdeanalys</h4>
                    <table class="value-table">
                        <thead>
                            <tr>
                                <th>Tecken</th>
                                <th>Odds</th>
                                <th>Sannolikhet</th>
                                <th>Streck</th>
                                <th>V√§rde</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="{% if match.analysis.home_value and match.analysis.home_value >= 1.05 %}value-good{% endif %}">
                                <td><strong>1</strong></td>
                                <td>{{ "%.2f"|format(match.analysis.avg_home_odds) }}</td>
                                <td>{{ "%.1f"|format(match.analysis.true_home_prob * 100) }}%</td>
                                <td>{{ "%.0f"|format(match.home_percentage) }}%</td>
                                <td><strong>{{ "%.2f"|format(match.analysis.home_value) if match.analysis.home_value else "-" }}</strong></td>
                            </tr>
                            <tr class="{% if match.analysis.draw_value and match.analysis.draw_value >= 1.05 %}value-good{% endif %}">
                                <td><strong>X</strong></td>
                                <td>{{ "%.2f"|format(match.analysis.avg_draw_odds) }}</td>
                                <td>{{ "%.1f"|format(match.analysis.true_draw_prob * 100) }}%</td>
                                <td>{{ "%.0f"|format(match.draw_percentage) }}%</td>
                                <td><strong>{{ "%.2f"|format(match.analysis.draw_value) if match.analysis.draw_value else "-" }}</strong></td>
                            </tr>
                            <tr class="{% if match.analysis.away_value and match.analysis.away_value >= 1.05 %}value-good{% endif %}">
                                <td><strong>2</strong></td>
                                <td>{{ "%.2f"|format(match.analysis.avg_away_odds) }}</td>
                                <td>{{ "%.1f"|format(match.analysis.true_away_prob * 100) }}%</td>
                                <td>{{ "%.0f"|format(match.away_percentage) }}%</td>
                                <td><strong>{{ "%.2f"|format(match.analysis.away_value) if match.analysis.away_value else "-" }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="recommendation-box">
                        <strong>Rekommendation:</strong> {{ match.analysis.recommended_signs }}
                    </div>
                </div>

                {% if match.analysis.expert_summary %}
                <div class="expert-section">
                    <h4>Expertkonsensus (AI-sammanfattning)</h4>
                    <p>{{ match.analysis.expert_summary }}</p>
                </div>
                {% endif %}

                {% if expert_consensus and expert_consensus.get(match.id) %}
                <div class="expert-consensus-section">
                    <h4>üìä Experttips fr√•n svenska k√§llor</h4>
                    {% set consensus = expert_consensus[match.id] %}

                    <div class="consensus-summary">
                        <div class="consensus-pick">
                            <span class="consensus-label">Konsensus:</span>
                            <span class="pick-badge pick-{{ consensus.consensus_pick }}">
                                {{ consensus.consensus_pick }}
                            </span>
                            <span class="consensus-confidence">
                                ({{ (consensus.confidence * 100)|int }}% enighet, {{ consensus.prediction_count }} experter)
                            </span>
                        </div>

                        <div class="pick-distribution">
                            <strong>F√∂rdelning:</strong>
                            {% for pick, count in consensus.pick_distribution.items() %}
                                <span class="dist-item">
                                    <span class="dist-pick">{{ pick }}</span>: {{ count }} st
                                </span>
                            {% endfor %}
                        </div>
                    </div>

                    <details class="expert-details">
                        <summary>Visa alla experttips ({{ consensus.prediction_count }} st)</summary>
                        <div class="sources-list">
                            {% for source, preds in consensus.source_breakdown.items() %}
                                <div class="source-group">
                                    <strong class="source-name">{{ source }}:</strong>
                                    {% for pred in preds %}
                                        <span class="expert-pick">
                                            <span class="pick-value">{{ pred.pick }}</span>
                                            {% if pred.author %}
                                                <span class="expert-author">({{ pred.author }})</span>
                                            {% endif %}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </details>
                </div>
                {% endif %}

                {% if match.odds %}
                <div class="odds-section">
                    <h4>Odds fr√•n bookmakers</h4>
                    <table class="odds-table">
                        <thead>
                            <tr>
                                <th>Bookmaker</th>
                                <th>1</th>
                                <th>X</th>
                                <th>2</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for odds in match.odds %}
                            <tr>
                                <td>{{ odds.bookmaker }}</td>
                                <td>{{ "%.2f"|format(odds.home_odds) }}</td>
                                <td>{{ "%.2f"|format(odds.draw_odds) }}</td>
                                <td>{{ "%.2f"|format(odds.away_odds) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            {% else %}
                <p class="no-analysis">Ingen analys tillg√§nglig f√∂r denna match.</p>
            {% endif %}
        </div>
    {% endfor %}
</section>

{% if suggested_rows %}
<section class="suggested-rows-detailed">
    <h3>F√∂reslagna rader</h3>
    {% for row in suggested_rows %}
        <div class="row-card-detailed">
            <div class="row-header">
                <h4>Rad {{ loop.index }}</h4>
                <div class="row-stats">
                    <span class="ev">F√∂rv√§ntat v√§rde: {{ "%.3f"|format(row.expected_value) }}</span>
                    <span>Helgarderingar: {{ row.half_cover_count }}</span>
                    <span>Kostnad: {{ row.cost_factor }}x basinvestering</span>
                </div>
            </div>
            <div class="row-grid">
                {% for match_num in range(1, 14) %}
                    <div class="row-cell {% if row.row_data[match_num|string]|length > 1 %}half-cover{% endif %}">
                        <span class="cell-number">{{ match_num }}</span>
                        <span class="cell-sign">{{ row.row_data[match_num|string] }}</span>
                    </div>
                {% endfor %}
            </div>
            <p class="row-reasoning">{{ row.reasoning }}</p>
        </div>
    {% endfor %}
</section>
{% endif %}

<div class="back-link">
    <a href="/">&larr; Tillbaka till start</a>
</div>

<style>
/* Expert consensus styling */
.expert-consensus-section {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #f0f9ff;
    border-radius: 8px;
    border-left: 4px solid #2563eb;
}

.expert-consensus-section h4 {
    margin-top: 0;
    color: #1e40af;
}

.consensus-summary {
    margin-bottom: 1rem;
}

.consensus-pick {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.consensus-label {
    font-weight: 600;
    color: #333;
}

.pick-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: bold;
    font-size: 1.2rem;
}

.pick-badge.pick-1 { background: #dcfce7; color: #166534; }
.pick-badge.pick-X { background: #fef3c7; color: #92400e; }
.pick-badge.pick-2 { background: #fee2e2; color: #991b1b; }
.pick-badge.pick-1X { background: #dbeafe; color: #1e40af; }
.pick-badge.pick-X2 { background: #fce7f3; color: #9f1239; }
.pick-badge.pick-12 { background: #e0e7ff; color: #3730a3; }

.consensus-confidence {
    color: #666;
    font-size: 0.9rem;
}

.pick-distribution {
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
}

.dist-item {
    display: inline-block;
    margin-right: 1rem;
    padding: 0.25rem 0.5rem;
    background: #f3f4f6;
    border-radius: 4px;
    font-size: 0.9rem;
}

.dist-pick {
    font-weight: bold;
    color: #2563eb;
}

.expert-details {
    margin-top: 1rem;
}

.expert-details summary {
    cursor: pointer;
    font-weight: 500;
    color: #2563eb;
    padding: 0.5rem;
    background: white;
    border-radius: 6px;
    user-select: none;
}

.expert-details summary:hover {
    background: #f3f4f6;
}

.sources-list {
    margin-top: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 6px;
}

.source-group {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.source-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.source-name {
    display: block;
    margin-bottom: 0.5rem;
    color: #1e40af;
}

.expert-pick {
    display: inline-block;
    margin-right: 0.75rem;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: #f3f4f6;
    border-radius: 4px;
    font-size: 0.9rem;
}

.pick-value {
    font-weight: bold;
    color: #2563eb;
    margin-right: 0.25rem;
}

.expert-author {
    color: #666;
    font-size: 0.85rem;
}
</style>

{% endblock %}
